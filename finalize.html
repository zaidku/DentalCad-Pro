<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalize - DentalCAD Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Three.js for 3D rendering -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // Fix for Three.js loaders
        if (window.STLLoader && !THREE.STLLoader) {
            THREE.STLLoader = window.STLLoader;
        }
        if (window.OrbitControls && !THREE.OrbitControls) {
            THREE.OrbitControls = window.OrbitControls;
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dental: {
                            primary: '#f97316',
                            secondary: '#ea580c',
                            dark: '#0c0a09',
                            light: '#f5f5f4',
                            accent: '#fdba74',
                        },
                    },
                }
            }
        }
    </script>
    
    <style>
        .glass-effect {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(15, 23, 42, 0.8);
        }

        /* Workflow Progress Styles */
        .workflow-step {
            display: flex;
            align-items: center;
            position: relative;
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 2rem;
            height: 2px;
            background-color: rgba(55, 65, 81, 0.8);
        }

        .workflow-step.active::after {
            background-color: #f97316;
        }

        .workflow-step.completed::after {
            background-color: #10b981;
        }

        .step-circle {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            border: 2px solid rgba(55, 65, 81, 0.8);
            background-color: rgba(31, 41, 55, 0.8);
            color: #9ca3af;
        }

        .workflow-step.active .step-circle {
            border-color: #f97316;
            background-color: #f97316;
            color: white;
        }

        .workflow-step.completed .step-circle {
            border-color: #10b981;
            background-color: #10b981;
            color: white;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            outline: none;
        }

        .view-button.active {
            background-color: #f97316;
            color: white;
        }
    </style>
</head>
<body class="h-full overflow-hidden text-gray-200">
    <!-- Workflow Progress -->
    <div id="workflowProgressContainer"></div>

    <div class="flex" style="height: calc(100vh - 80px);">
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-gray-800 border-b border-gray-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-check-circle text-dental-primary mr-3"></i>
                            Finalize Design
                        </h1>
                        <p class="text-sm text-gray-400 mt-1">Final inspection and export preparation</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-sm bg-gray-700 rounded-full px-3 py-1">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="stageTimer">00:00</span>
                        </div>
                        <div class="text-sm bg-green-700 rounded-full px-3 py-1">
                            <i class="fas fa-check mr-1"></i>
                            Design Complete
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Controls -->
            <div class="bg-gray-750 border-b border-gray-700 p-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-400">View:</span>
                        <button id="viewUpper" class="view-button active px-3 py-1 rounded text-sm bg-gray-700 hover:bg-dental-primary">
                            <i class="fas fa-arrow-up mr-1"></i>Upper
                        </button>
                        <button id="viewLower" class="view-button px-3 py-1 rounded text-sm bg-gray-700 hover:bg-dental-primary">
                            <i class="fas fa-arrow-down mr-1"></i>Lower
                        </button>
                        <button id="viewCrown" class="view-button px-3 py-1 rounded text-sm bg-gray-700 hover:bg-dental-primary">
                            <i class="fas fa-crown mr-1"></i>Crown
                        </button>
                        <button id="viewAll" class="view-button px-3 py-1 rounded text-sm bg-gray-700 hover:bg-dental-primary">
                            <i class="fas fa-cube mr-1"></i>All
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="inspectionMode" class="px-3 py-1 rounded text-sm bg-gray-700 hover:bg-dental-primary">
                            <i class="fas fa-search mr-1"></i>Inspection Mode
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3D Viewport -->
            <div class="flex-1 relative bg-gray-900">
                <canvas id="renderCanvas"></canvas>
                
                <!-- Viewport Controls -->
                <div class="absolute top-4 left-4 space-y-2">
                    <button class="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded-lg shadow-lg" title="Reset View">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded-lg shadow-lg" title="Fit to Screen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded-lg shadow-lg" title="Take Screenshot">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>

                <!-- Quality Checklist -->
                <div class="absolute bottom-4 left-4 bg-gray-800 rounded-lg p-4 shadow-lg">
                    <h4 class="text-sm font-medium text-white mb-3 flex items-center">
                        <i class="fas fa-clipboard-check text-dental-primary mr-2"></i>
                        Quality Checklist
                    </h4>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Margin Fit</span>
                            <i id="marginFitStatus" class="fas fa-check-circle text-green-500"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Occlusion</span>
                            <i id="occlusionStatus" class="fas fa-check-circle text-green-500"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Anatomy</span>
                            <i id="anatomyStatus" class="fas fa-check-circle text-green-500"></i>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Wall Thickness</span>
                            <i id="wallThicknessStatus" class="fas fa-check-circle text-green-500"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col">
            <!-- Order Summary -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="font-medium mb-3 flex items-center">
                    <i class="fas fa-file-contract text-dental-primary mr-2"></i>
                    Order Summary
                </h3>
                <div id="orderSummary" class="space-y-2 text-sm">
                    <!-- Order details will be loaded here -->
                </div>
            </div>

            <!-- Manufacturing Details -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="font-medium mb-3 flex items-center">
                    <i class="fas fa-cogs text-dental-primary mr-2"></i>
                    Manufacturing
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Milling Time:</span>
                        <span class="text-white">45 min</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Material Usage:</span>
                        <span class="text-white">12.5mm³</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tool Path:</span>
                        <span class="text-green-400">Optimized</span>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="font-medium mb-3 flex items-center">
                    <i class="fas fa-download text-dental-primary mr-2"></i>
                    Export Options
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-400">Include Upper</label>
                        <input type="checkbox" id="exportUpper" checked class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-400">Include Lower</label>
                        <input type="checkbox" id="exportLower" checked class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-gray-400">Include Crown</label>
                        <input type="checkbox" id="exportCrown" checked class="rounded">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Resolution</label>
                        <select id="exportResolution" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                            <option value="high">High (0.1mm)</option>
                            <option value="medium" selected>Medium (0.2mm)</option>
                            <option value="low">Low (0.3mm)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- File Information -->
            <div class="flex-1 p-4">
                <h3 class="font-medium mb-3 flex items-center">
                    <i class="fas fa-info-circle text-dental-primary mr-2"></i>
                    Export Files
                </h3>
                <div class="space-y-2 text-sm">
                    <div class="bg-gray-700 rounded p-2">
                        <div class="font-medium text-white">Crown_Final.stl</div>
                        <div class="text-gray-400">2.4 MB • Ready</div>
                    </div>
                    <div class="bg-gray-700 rounded p-2">
                        <div class="font-medium text-white">Upper_Model.stl</div>
                        <div class="text-gray-400">5.1 MB • Ready</div>
                    </div>
                    <div class="bg-gray-700 rounded p-2">
                        <div class="font-medium text-white">Lower_Model.stl</div>
                        <div class="text-gray-400">4.8 MB • Ready</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 border-t border-gray-700 space-y-3">
                <button id="exportFiles" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>
                    Export STL Files
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button id="saveProject" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-save mr-1"></i>
                        Save Project
                    </button>
                    <button id="backToDesign" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center">
                        <i class="fas fa-arrow-left mr-1"></i>
                        Back
                    </button>
                </div>
                <button id="newOrder" class="w-full bg-dental-primary hover:bg-dental-secondary text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Start New Order
                </button>
            </div>
        </div>
    </div>

    <!-- Export Progress Modal -->
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-white mb-4">Exporting Files</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Crown_Final.stl</span>
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Upper_Model.stl</span>
                    <i id="upperProgress" class="fas fa-spinner fa-spin text-dental-primary"></i>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-400">Lower_Model.stl</span>
                    <i id="lowerProgress" class="fas fa-circle text-gray-500"></i>
                </div>
            </div>
            <div class="mt-6">
                <div class="bg-gray-700 rounded-full h-2">
                    <div id="exportProgress" class="bg-dental-primary h-2 rounded-full transition-all duration-300" style="width: 33%"></div>
                </div>
                <div class="text-center text-sm text-gray-400 mt-2">Exporting... <span id="exportPercent">33%</span></div>
            </div>
        </div>
    </div>

    <!-- Workflow Progress Script -->
    <script src="js/workflowProgress.js"></script>
    
    <script>
        // Finalize Stage JavaScript
        let scene, camera, renderer, controls;
        let currentView = 'upper';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ Finalize Stage initialized');
            
            loadOrderSummary();
            initializeThreeJS();
            initializeControls();
            startTimer();
        });

        function loadOrderSummary() {
            const orderData = JSON.parse(localStorage.getItem('dentalOrderData') || '{}');
            
            if (Object.keys(orderData).length === 0) {
                document.getElementById('orderSummary').innerHTML = '<p class="text-gray-400">No order data found</p>';
                return;
            }

            const orderHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Order ID:</span>
                        <span class="text-dental-primary font-mono text-xs">${orderData.orderId || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Patient:</span>
                        <span class="text-white">${orderData.patientName || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Teeth:</span>
                        <span class="text-white">${orderData.selectedTeeth ? orderData.selectedTeeth.join(', ') : 'None'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Material:</span>
                        <span class="text-white">${orderData.selectedMaterial || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Shade:</span>
                        <span class="text-white">${orderData.selectedShade || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Due Date:</span>
                        <span class="text-white">${orderData.dateRequired || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('orderSummary').innerHTML = orderHTML;
        }

        function initializeThreeJS() {
            const canvas = document.getElementById('renderCanvas');
            const container = canvas.parentElement;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1f2937);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Handle resize
            window.addEventListener('resize', onWindowResize);

            // Start render loop
            animate();
        }

        function initializeControls() {
            // View buttons
            document.querySelectorAll('.view-button').forEach(button => {
                button.addEventListener('click', function() {
                    selectView(this.id.replace('view', '').toLowerCase());
                });
            });

            // Export button
            document.getElementById('exportFiles').addEventListener('click', startExport);

            // Navigation buttons
            document.getElementById('saveProject').addEventListener('click', saveProject);
            document.getElementById('backToDesign').addEventListener('click', function() {
                workflowProgress.navigateToStage(4);
            });
            document.getElementById('newOrder').addEventListener('click', function() {
                if (confirm('Start a new order? This will clear the current project.')) {
                    localStorage.removeItem('dentalOrderData');
                    localStorage.removeItem('dentalWorkflowCompleted');
                    workflowProgress.navigateToStage(1);
                }
            });
        }

        function selectView(viewName) {
            // Update button states
            document.querySelectorAll('.view-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`view${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`).classList.add('active');
            
            currentView = viewName;
            console.log(`Switched to ${viewName} view`);
        }

        function startExport() {
            const modal = document.getElementById('exportModal');
            modal.classList.remove('hidden');
            
            // Simulate export progress
            let progress = 33;
            const progressBar = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportPercent');
            const upperProgress = document.getElementById('upperProgress');
            const lowerProgress = document.getElementById('lowerProgress');
            
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
                
                if (progress === 66) {
                    upperProgress.className = 'fas fa-check-circle text-green-500';
                    lowerProgress.className = 'fas fa-spinner fa-spin text-dental-primary';
                } else if (progress >= 100) {
                    lowerProgress.className = 'fas fa-check-circle text-green-500';
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        workflowProgress.showNotification('Files exported successfully!', 'success');
                        
                        // Mark workflow as complete
                        workflowProgress.markStageComplete(5);
                    }, 1000);
                }
            }, 1000);
        }

        function saveProject() {
            const projectData = {
                orderData: JSON.parse(localStorage.getItem('dentalOrderData') || '{}'),
                designProgress: JSON.parse(localStorage.getItem('dentalDesignProgress') || '{}'),
                workflowCompleted: JSON.parse(localStorage.getItem('dentalWorkflowCompleted') || '[]'),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('dentalProjectBackup', JSON.stringify(projectData));
            workflowProgress.showNotification('Project saved successfully', 'success');
        }

        function onWindowResize() {
            const container = document.getElementById('renderCanvas').parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function startTimer() {
            let seconds = 0;
            setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('stageTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }
    </script>
</body>
</html>
